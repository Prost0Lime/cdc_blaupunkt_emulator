# cdc_blaupunkt_emulator
Эмулятор cd-changer на основе **Arduino Pro Micro ATmega32u4** для
**Blaupunkt BP7432** (96829594) - 1DIN — Radio, 1CD, без МР3, без AUX в меню, взаимозаменяемая съемная панель с BР7435 на основе **Arduino Pro Micro ATmega32u4**.

Данное решение *вероятно* подойдёт для **Blaupunkt BР7435** (96829597) 1DIN — Radio, 1CD, с МР3, без AUX в меню, взаимозаменяемая съемная панель с BР7432.

------------

#### Полезные ссылки

для создания была использована полезная информация:

- https://github.com/kuai6/blaupunkt-cdc-protocol
- https://forum.arduino.cc/t/arduino-as-a-cd-changer-emulator-9-databit-serial/273253/12
- найденные по веб-архивам полезные файлы с реверс-докуменацией [здесь](https://github.com/Prost0Lime/cdc_blaupunkt_emulator/tree/main/useful_information "тут")

------------
### Цель

Включить в магнитоле режим CHANGER и использовать пины CDC NF-L & CDC NF-R для подключения AUX | Bluetooth-модуля.

#### Распиновка разъёма магнитолы

<a href="https://ibb.co/nnNK5zR"><img src="https://i.ibb.co/nnNK5zR/blaupunkt-chevrolet.jpg" alt="blaupunkt-chevrolet" border="0"></a>

#### Питание

Подключение модуля LM2596 DC/DC BUCK 3A:

|  14V SWITCH CDC | LM2596 DC/DC BUCK 3A  |  OUT  |
| ------------ | ------------ | ------------ |
|  14V SWITCH CDC | 14V > 5V |  OUT + |
|  CDC CHANGER GROUND  |  --------  |  OUT - |

------------

### Старт инициализации CDC
При включении магнитолы она отправляет один (и три повторных) 9-битный сигнал **0x180** на скорости 4800 бод

<a href="https://ibb.co/Js4LNVm"><img src="https://i.ibb.co/Js4LNVm/photo-2025-01-22-23-16-29.jpg" alt="photo-2025-01-22-23-16-29" border="0"></a> <a href="https://ibb.co/92wy81g"><img src="https://i.ibb.co/92wy81g/photo-2025-01-22-23-16-31.jpg" alt="photo-2025-01-22-23-16-31" border="0"></a> 

Сигнал - TTL с инверсией. Для инвертирования использовался RS232<>TTL SP3232.

### Работа с сигналами

#### Структура пакета

Магнитола общается "пакетами", каждый пакет имеет:
- **0x180** - объявление о начале передачи
- **Сообщение**
- **0x14F** так же встречается  **0x04F** - конец передачи (не требует ответа)

#### Эхо-ответы

На все отправляемые магнитолой сигналы она ожидает ответа, за исключением сигнала **0x14F** (конец передачи "пакета"). В большинстве случаев магнитола ожидает эхо-ответы, но есть исключения.

#### Обмен сигналами

*Пакет 1*

| Магнитола | Направление | Эмулятор |
| ------------ | ------------ | ------------ |
| 0x180 | → → → → → → | 0x180 |
| 0x1AD | → → → → → → | 0x1AD |
| 0x080 | → → → → → → | 0x080 |
| 0x04F | → → → → → → | --- |

*Пакет 2*

| Магнитола | Направление | Эмулятор |
| ------------ | ------------ | ------------ |
| 0x180 | → → → → → → | 0x180 |
| 0x1AD | → → → → → → | 0x1AD |
| 0x080 | → → → → → → | 0x080 |
| 0x04F | → → → → → → | 0x04F |
| 0x14F | → → → → → → | --- |

*Пакет 3*

| Магнитола | Направление | Эмулятор |
| ------------ | ------------ | ------------ |
| --- | задержка 30 (мс)| --- |
| 0x10F | ← ← ← ← ← ← | 0x10F |
| --- | задержка 21 (мс)| --- |
| 0x048 | ← ← ← ← ← ← | 0x048 |
| --- | задержка 21 (мс)| --- |
| 0x001 | ← ← ← ← ← ← | 0x001 |
| --- | задержка 21 (мс)| --- |
| 0x14F | ← ← ← ← ← ← | 0x14F |
| --- | задержка 21 (мс)| --- |

*Пакет 4*

| Магнитола | Направление | Эмулятор |
| ------------ | ------------ | ------------ |
| 0x180 | → → → → → → | 0x180 |
| 0x148 | → → → → → → | 0x048 |
| 0x04F | → → → → → → | 0x04F |
| 0x002 | → → → → → → | 0x002 |
| 0x14F | → → → → → → | --- |

далее - задержка 10(мс) и переключение скорости на 9600 бод

После этого в магнитоле появится возможность переключения на режим CHANGER

#### Объявление диска и его исправности

Возможно не обязательное, но было добавлено (с ним точно работает).
Хоть тут и указывается номер диска, есть вероятность что магнитола определит его номер случайным образом (см. пункт Возможные ошибки)

| Магнитола | Направление | Эмулятор |
| ------------ | ------------ | ------------ |
| 0x101 | ← ← ← ← ← ← | 0x101 |
| 0x001 | ← ← ← ← ← ← | 0x001 |
| 0x001 | ← ← ← ← ← ← | 0x001 |
| 0x14F | ← ← ← ← ← ← | 0x14F |

------------

### Прошивка

После подключения питания от магнитолы, Arduino Pro Micro из-за загрузчика Caterina не успевает запустить выполнение кода эмуляции до того, как магнитола отправляет сигнал и ожидает на него ответа:

| Временная развёртка | Готовность|
| ------------ | ------------ |
| Магнитола |  ===0x180=0x180=0x180=0x180========================= |
|  Ардуино  |  =====================================Ready====== |
|  t.(c)  |  0===============================2============== |

Решение проблемы:
1. использовать другой загрузчик (не использовалось);
2. прошить скетч с помощью программатора ISP с затиранием загрузчика (использовалось).

#### Схема подключения ISP

Arduino Nano v3 в качестве программатора

| Nano (ISP) | Pro Micro |
|------------ | ------------ |
| D10 | RST |
| D11 | MOSI (D16) |
| D12 | MISO (D14) |
| D13 | SCK (D15) |
| GND | GND |
| 5V  | VCC |

### Включение аудио в режиме CHANGER в магнитоле

<a href="https://ibb.co/1zYgNw7"><img src="https://i.ibb.co/Z2RjrkG/image.png" alt="image" border="0"></a>

1. Для входа в режим CHANGER — нажать кнопку **5**
2. Включение звука осуществляется постановкой на паузу и снятием с неё нажатием на кнопку "3 ||" в блоке кнопок **10**
------------

### Возможные ошибки

#### Вид ошибки

1. Надпись MAGAZINE — вероятно ошибка чтения дисков
2. Надпись CHANGER - ERROR — "ошибка инициализации Cd-changer"
3. Надпись NO DISK — ошибка "отсутствие диска"

#### Причина появления

Появление ошибок может быть связано с номером диска отличным от того, который магнитола запомнила при предыдущем включении.

#### Решение

Все ошибки решаются перезапуском магнитолы, для точного решения проблемы — перезапуск с некоторой задержкой.

#### Рекомендации

Рекомендуется выходить из режима CHANGER перед выключением магнитолы для устранения ошибки "CHANGER - ERROR"

------------

### Не реализовано

1. Синхронизация получаемого аудио из AUX / модуля Bluetooth с экраном и органами управления магнитолы (время трека / названия / установка и снятие с паузы / переключение треков и тд.);
2. Авто воспроизведение и авто стоп аудио при выходе из режима CHANGER.
