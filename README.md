# cdc_blaupunkt_emulator
Эмулятор cd-changer на основе **Arduino Pro Micro ATmega32u4** для
**Blaupunkt BP7432** (96829594) - 1DIN — Radio, 1CD, без МР3, без AUX в меню, взаимозаменяемая съемная панель с BР7435 на основе **Arduino Pro Micro ATmega32u4**.

Данное решение *вероятно* подойдёт для **Blaupunkt BР7435** (96829597) 1DIN — Radio, 1CD, с МР3, без AUX в меню, взаимозаменяемая съемная панель с BР7432.

------------
[TOC]

#### Полезные ссылки

для создания была полезной информация:

- https://github.com/kuai6/blaupunkt-cdc-protocol
- https://forum.arduino.cc/t/arduino-as-a-cd-changer-emulator-9-databit-serial/273253/12
- найденные по веб-архивам полезные файлы с реверс-докуменацией [здесь](https://github.com/Prost0Lime/cdc_blaupunkt_emulator/tree/main/useful_information "тут")

------------
### Цель 

Включить в магнитоле режим CHANGER и использовать пины CDC NF-L & CDC NF-R для подключения AUX | Bluetooth-модуля.

#### Распиновка раъёма магнитолы

<a href="https://ibb.co/nnNK5zR"><img src="https://i.ibb.co/nnNK5zR/blaupunkt-chevrolet.jpg" alt="blaupunkt-chevrolet" border="0"></a>

#### Питание

Подключение модуля LM2596 DC/DC BUCK 3A:

|   14V SWITCH CDC | LM2596 DC/DC BUCK 3A  |  OUT  |
| ------------ | ------------ | ------------ |
|   14V SWITCH CDC | 14V > 5V |  OUT + |
|   CDC CHANGER GROUND  |  --------  |   OUT - |




### Инициализация CDC
При включении магнитолы она отправляет 4 9-битных сигнала **0x180**

<a href="https://ibb.co/Js4LNVm"><img src="https://i.ibb.co/Js4LNVm/photo-2025-01-22-23-16-29.jpg" alt="photo-2025-01-22-23-16-29" border="0"></a> <a href="https://ibb.co/92wy81g"><img src="https://i.ibb.co/92wy81g/photo-2025-01-22-23-16-31.jpg" alt="photo-2025-01-22-23-16-31" border="0"></a> 

Сигнал - TTL с инверсией. Для инвертирования использовался RS232<>TTL SP3232.

### Прошивка

После подключения питания от магнитолы, Arduino Pro Micro не успевает запустить выполнение кода эмуляции до того, как магнитола отправляет сигнал и ожидает на него ответа из-за загрузчика Caterina:

| Временная развёртка | Готовность|
| ------------ | ------------ |
| Магнитола |  ===0x180=0x180=0x180=0x180========================= |
|  Ардуино  |  =====================================Ready====== |
|  t.(c)  |  0===============================2============== |

В связи с этим решение проблемы:
1. использовать другой загрузчик (не использовалось);
2. прошить скетч с помощью программатора ISP (использовалось).

#### Cхема подключения ISP

Arduino Nano v3 в качестве программатора 

| Nano (ISP) | Pro Micro |
|------------ | ------------ |
| D10 | RST |
| D11 | MOSI (D16) |
| D12 | MISO (D14) |
| D13 | SCK (D15) |
| GND | GND |
| 5V  | VCC |

### Включение аудио в режиме CHANGER в магнитоле

<a href="https://ibb.co/1zYgNw7"><img src="https://i.ibb.co/Z2RjrkG/image.png" alt="image" border="0"></a>

1. Для вход в режим CHANGER - нажать кнопку **5** 
2. Включение звука осуществляется постановкой на паузу и снятием с неё нажатием на кнопку "3 ||▶" в блоке кнопок **10**
------------



### Недоработки

Нет  реализации синхронизации получаемого аудио из AUX / модуля Bluetooth с экраном и органами управления (время трека / названия / установка и снятие с паузы / переключение треков и тд.) 

